<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 1:1 Demo</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        #conversation, #private-message-section {
            display: none;
            margin-top: 20px;
        }
        #greetings {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h2>WebSocket 1:1 Demo</h2>
                <div class="form-group">
                    <input type="text" id="username" class="form-control" placeholder="Enter your username">
                    <button id="connect" class="btn btn-success mt-2">Connect</button>
                    <button id="disconnect" class="btn btn-danger mt-2" disabled>Disconnect</button>
                </div>
                <div id="conversation" class="form-group">
                    <h3>Conversation</h3>
                    <table class="table table-striped">
                        <thead>
                            <tr><th>Messages</th></tr>
                        </thead>
                        <tbody id="greetings"></tbody>
                    </table>
                </div>
                <div class="form-group">
                    <input type="text" id="name" class="form-control" placeholder="Enter your message">
                    <button id="send" class="btn btn-primary mt-2">Send Public</button>
                </div>
                <div id="private-message-section" class="form-group">
                    <input type="text" id="recipient" class="form-control" placeholder="Enter recipient's username">
                    <input type="text" id="privateName" class="form-control mt-2" placeholder="Enter your private message">
                    <button id="sendPrivate" class="btn btn-secondary mt-2">Send Private</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let stompClient = null;
        let username = null;

        function setConnected(connected) {
            $("#connect").prop("disabled", connected);
            $("#disconnect").prop("disabled", !connected);
            if (connected) {
                $("#conversation").show();
                $("#private-message-section").show();
            } else {
                $("#conversation").hide();
                $("#private-message-section").hide();
            }
            $("#greetings").html("");
        }

        function connect() {
            username = $("#username").val();
            if (!username) {
                alert("Please enter a username");
                return;
            }

            const socket = new SockJS('http://localhost:8080/gs-guide-websocket');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, (frame) => {
                setConnected(true);
                console.log('Connected: ' + frame);
                stompClient.subscribe('/topic/greetings', (greeting) => {
                    showGreeting(JSON.parse(greeting.body).content);
                });
                stompClient.subscribe('/user/' + username + '/queue/reply', (message) => {
                    showPrivateGreeting(JSON.parse(message.body).content);
                });
            }, (error) => {
                console.error('Error with websocket', error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            setConnected(false);
            console.log("Disconnected");
        }

        function sendName() {
            stompClient.send("/app/hello", {}, JSON.stringify({'name': $("#name").val()}));
        }

        function sendPrivateName() {
            const recipient = $("#recipient").val();
            stompClient.send("/app/private-message", {}, JSON.stringify({'recipient': recipient, 'name': $("#privateName").val()}));
        }

        function showGreeting(message) {
            $("#greetings").append("<tr><td>" + message + "</td></tr>");
        }

        function showPrivateGreeting(message) {
            $("#greetings").append("<tr><td><b>" + message + "</b></td></tr>");
        }

        $(function () {
            $("form").on('submit', (e) => e.preventDefault());
            $("#connect").click(() => connect());
            $("#disconnect").click(() => disconnect());
            $("#send").click(() => sendName());
            $("#sendPrivate").click(() => sendPrivateName());
        });
    </script>
</body>
</html>
